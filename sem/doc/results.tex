\chapter{Results}
\label{chapter:results}

In this chapter we will analyze with which accuracy the algorithm from chapter~\ref{chapter:data_and_algorithm} classifies sleep stages. We will have a look into which frequencies differ most between the stages and whether the principal components of the PCA uses the same frequencies.

\section{Compression of Data}
From section~\ref{chapter:principal_component_analysis} we know that it is possible to use PCA to reduce dimensions of data. We want to know how much information is still present in the compressed data. This can be calculated by testing how many dimensions it takes to retain a certain amount of variance in the data.

We find the first index for which the sum of eigenvalues from the PCA is bigger than a certain percentage. The output for a few values are shown in table~\ref{tab:explained_variance}. As only few dimensions are needed to preserve 90\% of variance, which in our case means information, the PCA can successfully be used as a way to reduce the dimensions.

\begin{table}
	\centering
	\begin{tabular}{c|c}
		percentage of variance & number of dimensions needed \\
		\hline
		50\% & 1 out of 3000 \\
		80\% & 4 out of 3000 \\
		90\% & 24 out of 3000 \\
		95\% & 55 out of 3000 \\
	\end{tabular}
	\caption{Percentage of variance retained after reducing the dimension.}
	\label{tab:explained_variance}
\end{table}

\section{Testing the Accuracy}
To test the accuracy of the algorithm from section~\ref{sec:algorithm} we divide the dataset into two partitions, one for training the PCA and one for validating the results. The training data contains 11 of the 14 patients and the validation data contains the other 3 patients.

First the training data is used to calculate the principal components of the PCA. Then the validation data is transformed according to the principal components. Both the training and validation data are reduced to 24 dimensions, as we know that means only about 10\% of variance is lost. Lastly we use the k-nearest-neighbor algorithm to estimate the sleep stage of the validation data and compare it to the true classification. This is the algorithm~\ref{alg:gues_sleep_stage}.

When randomly guessing the sleep stage we expect an accuracy of 20\%, as there are five different stages. For better comparison of the accuracy achieved, we run an algorithm, that does not use PCA, but otherwise follow the same logic. In comparison to algorithm~\ref{alg:gues_sleep_stage} the algorithm~\ref{alg:gues_sleep_stage_without_PCA} does not reduce dimensions, as there is no clear way of doing this without using PCA.

\begin{algorithm}
	\caption{Get estimate for sleep stage without PCA}\label{alg:gues_sleep_stage_without_PCA}
	\begin{algorithmic}
		\Require{EEG recording of sleep}
		\For{each 30s segment}
		\State Do FFT on the segment
		\State Do k nearest neighbor
		\State Save the result of k nearest neighbor
		\EndFor
		\State \Return results of k nearest neighbor
	\end{algorithmic}
\end{algorithm}

We test different values for $k$ of the k-nearest-neighbor algorithm. Table~\ref{tab:error_validation_overview} gives a overview of the accuracy achieved with and without PCA and different values for $k$.

\begin{table}
	\centering
	\begin{tabular}{c|c|c}
		k & accuracy with PCA & accuracy without PCA \\
		\hline
		1  & 59.67\% & 50.80\% \\
		5  & 65.57\% & 56.13\% \\
		10 & 68.37\% & 57.73\% \\
		15 & 67.74\% & 56.60\% \\
		20 & 68.28\% & 57.42\% \\
		25 & 68.28\% & 56.39\% \\
		30 & 68.18\% & 56.89\% \\
		35 & 68.28\% & 56.73\% \\
	\end{tabular}
	\caption{Overview of accuracy achieved with different values for k of k-nearest-neighbor.}
	\label{tab:error_validation_overview}
\end{table}

Using $k=20$ yields the best outcome in this limited validation set. Out of TODO 30 second segments the algorithm estimated the correct one TODO times, which corresponds to a success rate of 68.40\%. Table~\ref{tab:error_validation} shows the outcome in more detail.

\begin{table}
	\centering
	\begin{subtable}{0.48\textwidth}
		\begin{tabular}{c|ccccc}
			    & S3  & S2  & S1 & REM & awake \\
			\hline
			S3 & 467  & 35  & 1  & 1  & 28 \\
			S2 & 339  & 1026  & 18  & 101  & 38 \\
			S1 & 0  & 2  & 4  & 2  & 21 \\
			REM & 4  & 258  & 64  & 577  & 44 \\
			awake & 3  & 33  & 8  & 11  & 102 \\
		\end{tabular}
	\end{subtable}
	\hfill
	\begin{subtable}{0.48\textwidth}
		\begin{tabular}{c|ccccc}
			   & S3  & S2  & S1 & REM & awake \\
			\hline
			S3 & 290  & 5  & 1  & 0  & 9 \\
			S2 & 508  & 803  & 4  & 11  & 29 \\
			S1 & 0  & 2  & 16  & 1  & 26 \\
			REM & 13  & 518  & 66  & 626  & 74 \\
			awake & 2  & 26  & 8  & 54  & 95 \\
		\end{tabular}
	\end{subtable}
	
	\caption{The left table shows output for the algorithm using PCA, while the right table is from the algorithm that does not use PCA. Both tables show the number of sleep stages assigned to each stage, with the true value corresponding to the column and the estimate from the algorithm corresponding to the row. For both tables $k=20$.}
	\label{tab:error_validation}
\end{table}


\section{Rhythm Analysis}
There are four rhythms observed in the EEG\cite[chapter~11]{Ganong1997}. These rhythms differ in the frequency and are characterized as

\begin{itemize}
	\item Alpha: 8 - 12 Hz
	\item Beta: 18 - 30 Hz
	\item Theta: 4 - 7 Hz
	\item Delta: $<$ 4 Hz
\end{itemize}

It is easy to analyze the presence of these rhythms when looking at the fourier transformed data, as shown in figure~\ref{fig:eeg_with_rhythm}.

We can now see if the output of the PCA gives importance to these rhythms. In figure~\ref{fig:pc_analysis} the sum of the absolute values of the first 24 principal components is shown. We chose 24 as from table~\ref{tab:explained_variance} we gather that 90\% of the variance is preserved. The most emphasis is given on the values from the theta rhythm. This was expected as the amplitudes in the FFT output are the highest in this region and we did not normalize the data before doing PCA.


\newpage
\begin{figure}
	\centering	
	\begin{tikzpicture}
		\begin{axis}[xlabel=Frequency (Hz), ylabel=Amplitude, width=\textwidth, height=0.3\textwidth]			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(8,0.000002)   (12,0.000002)} |- (axis cs:8,0) -- cycle;
			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(18,0.000002)   (30,0.000002)} |- (axis cs:18,0) -- cycle;
			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(4.1,0.000002)   (7,0.000002)} |- (axis cs:4.1,0) -- cycle;
			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(0,0.000002)   (3.9,0.000002)} |- (axis cs:0,0) -- cycle;
			
			\addplot+ [no marks, color=black] table[col sep=comma] {figs/fft_output.csv};
		\end{axis}
	\end{tikzpicture}
	
	\caption{Fourier transformed data with rhythms highlighted.}
	\label{fig:eeg_with_rhythm}
\end{figure}


\begin{figure}
	\centering	
	\begin{tikzpicture}
		\begin{axis}[xlabel=Frequency (Hz), ylabel=Amplitude, width=\textwidth, height=0.3\textwidth]			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(8,4)   (12,4)} |- (axis cs:8,0) -- cycle;
			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(18,4)   (30,4)} |- (axis cs:18,0) -- cycle;
			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(4.1,4)   (7,4)} |- (axis cs:4.1,0) -- cycle;
			
			\addplot+ [red, opacity=0.3, fill=red!90!black, no marks] coordinates 
			{(0,4)   (3.9,4)} |- (axis cs:0,0) -- cycle;
			
			\addplot+ [no marks, color=black] table[col sep=comma] {figs/pc_analysis.csv};
		\end{axis}
	\end{tikzpicture}
	
	\caption{Sum of the absolute values of the first 24 principal components.}
	\label{fig:pc_analysis}
\end{figure}

